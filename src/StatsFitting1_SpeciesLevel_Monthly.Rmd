---
title: "StatsFitting1_SpeciesLevel"
author: "Chris Terry"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script fits and saves brms models predicting size for each species:

log(Size)  ~ YearRescale + Temp  + Latitude + Sex

```{r message = FALSE}
library(tidyverse)
library(brms)
library(posterior)
```

```{r}
NHM_ForFitting <- read_csv(  '../data/NHM_for_models_monthly.csv')
OUM_ForFitting <- read_csv(  '../data/OUMNH_for_models_monthly.csv')
```

# NHM Fit with sex as an offset for each species

```{r}
## Cycle through each species to fit models 
Batches<- count(NHM_ForFitting,
                Sp)%>%
  arrange( n)

## 200 potential models to fit:
Batches$n %>% log10 %>% plot; abline(h = 2) # almost perfect log-normal plot
sum(Batches$n >100) # 52 species 

```

## Build unique Name for each brood
```{r}
Batches %>%
  filter( n >100 ) -> TableOfModels_NHM

median(TableOfModels_NHM$n)

Set2 = paste0('Sp.', TableOfModels_NHM$Sp)
```

```{r eval = FALSE}
### Define and compile model
CoreModel2 <-   NHM_ForFitting %>%
    filter(Sp == TableOfModels_NHM$Sp[1]) %>%
    brm( log(Right_wing)  ~ YearRescale + Temp  + Latitude + Sex,
         data = ., refresh = 0)

## Refit model to each set of data, saving each time
for( i in 1:nrow( TableOfModels_NHM)){
  print(Set2[i])
  NHM_ForFitting %>%
    filter(Sp == TableOfModels_NHM$Sp[i]) -> batchDATA
  update( CoreModel2, newdata = batchDATA, refresh = 0) -> MODEL_FIT
  save(MODEL_FIT, file = paste('../NHM_modelfitsM1/',Set2[i]  ))
}

```

### Correlations between predictors

For each species calculate correlation between predictors

```{r}
map_df(TableOfModels_NHM$Sp ,function(sp_i){
  
  NHM_ForFitting%>%
    filter(Sp == sp_i) %>%
    select(Latitude ,Year,Temp) %>%
    cor ->x
  return(data.frame( Species = sp_i,
                       YvL = x[2,1],
                     YvT = x[2,3],
                     LvT = x[1,3]))
})-> SpeciesLvlCorrs

par(mfrow= c(1,3))
SpeciesLvlCorrs$YvL %>% hist(breaks=20, main ='Year v Latitude')
abline(v=0, col = 'red'); abline(v=mean(SpeciesLvlCorrs$YvL), col = 'blue')
SpeciesLvlCorrs$YvT %>% hist(breaks=20, main ='Year v Temperature')
abline(v=0, col = 'red'); abline(v=mean(SpeciesLvlCorrs$YvT), col = 'blue')
SpeciesLvlCorrs$LvT %>% hist(breaks=20, main ='Temperature v Latitude')
abline(v=0, col = 'red'); abline(v=mean(SpeciesLvlCorrs$LvT), col = 'blue')

png(file ='../figs/SI_corr_inTempLatYear.png',
    units ='in', width = 5, height = 3, res = 400)
par(mfrow= c(1,3))
SpeciesLvlCorrs$YvL %>% hist(breaks=20, main ='Year v Latitude')
abline(v=0, col = 'red'); abline(v=mean(SpeciesLvlCorrs$YvL), col = 'blue')
SpeciesLvlCorrs$YvT %>% hist(breaks=20, main ='Year v Temperature')
abline(v=0, col = 'red'); abline(v=mean(SpeciesLvlCorrs$YvT), col = 'blue')
SpeciesLvlCorrs$LvT %>% hist(breaks=20, main ='Temperature v Latitude')
abline(v=0, col = 'red'); abline(v=mean(SpeciesLvlCorrs$LvT), col = 'blue')
dev.off()


```


### Collating model outputs into a df

```{r eval = FALSE}
map_df(1:nrow( TableOfModels_NHM), function(i){
  load(file = paste('../NHM_modelfitsM1/',Set2[i]  )) 
  MODEL_FIT %>%
    as_draws_array %>%
    summarise_draws( "mean","median","sd","mad","quantile2",
                    ~quantile2(.x, probs = c(0.167, 0.833))) -> Fit_df
  Fit_df$Sp = TableOfModels_NHM$Sp[i]
  return(Fit_df)
})-> Posterior_Summaries_NHM2

write_csv(Posterior_Summaries_NHM2, '../statsresults/NHM_Posterior_Summaries_M1.csv')

```

# OUMNH with sex embedded

```{r}
## Cycle through each species to fit models 
Batches<- count(OUM_ForFitting,Sp)%>%
  arrange( desc(n))
Batches$n  %>% plot; abline(h = 40) # almost perfect log-normal plot
```

## Build unique Name for each brood
```{r}
Batches %>%
  filter( n >1) -> TableOfModels_OUMNH ## No longer include a threshold

TableOfModels_OUMNH$n %>% median

Set2 = paste0('Sp.', TableOfModels_OUMNH$Sp)

```

```{r eval = FALSE}
### Define and compile model when sexes are differentiated 
CoreModel_OU_splitSex <-   OUM_ForFitting %>%
  filter(Sp == TableOfModels_OUMNH$Sp[4]) %>%
  brm( log(Wing_Length)   ~ YearRescale + Temp  + Latitude + Sex,
       data = ., refresh = 0)

CoreModel_OU_jointSex <-   OUM_ForFitting %>%
  filter(Sp == TableOfModels_OUMNH$Sp[2]) %>%
  brm( log(Wing_Length)   ~ YearRescale + Temp  + Latitude ,
       data = ., refresh = 0)

undetermined_sp<- distinct(OUM_ForFitting, Sp, Sex) %>% filter( Sex == 'undetermined') %>% pluck('Sp')

## Refit model to each set of data, saving each time
for( i in 1:nrow( TableOfModels_OUMNH)){
  print(Set2[i])
  if(TableOfModels_OUMNH$Sp[i] %in% undetermined_sp ){
    OUM_ForFitting %>%
      filter(Sp == TableOfModels_OUMNH$Sp[i]) -> batchDATA
    update( CoreModel_OU_jointSex, newdata = batchDATA, refresh = 0) -> MODEL_FIT
    
  }else{
    OUM_ForFitting %>%
      filter(Sp == TableOfModels_OUMNH$Sp[i]) -> batchDATA
    update( CoreModel_OU_splitSex, newdata = batchDATA, refresh = 0) -> MODEL_FIT
  }
  save(MODEL_FIT, file = paste('../OUM_modelfitsM1/',Set2[i]  ))
}
```

### Collating model outputs into a df

```{r eval = FALSE}
map_df(1:nrow( TableOfModels_OUMNH), function(i){
  load(file = paste('../OUM_modelfitsM1/',Set2[i]  )) 
  MODEL_FIT %>%
    as_draws_array %>%
    summarise_draws("mean","median","sd","mad","quantile2",
                    ~quantile2(.x, probs = c(0.167, 0.833))) -> Fit_df
  Fit_df$Sp = TableOfModels_OUMNH$Sp[i]
  return(Fit_df)
})-> Posterior_Summaries_OUM2

write_csv(Posterior_Summaries_OUM2, '../statsresults/OUM_Posterior_Summaries_M1.csv')

```


```{R}
sessionInfo()

```