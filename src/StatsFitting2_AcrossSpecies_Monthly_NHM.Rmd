---
title: "Stats Fitting 2 Across Species NHM"
author: "Heywood et al."
output: 
  html_document: 
    toc: true
editor_options: 
  chunk_output_type: console
---

Main document for making main text results for the NHM data, comparing across species and fitting further models. Model fits at this level are saved in `TopLevelModelFits/`. 

# Packages and Data input
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(brms)
library(posterior)
library(forcats)
library(bayesplot)
library(cowplot)
library(ggrepel)
```

```{r}
## Summaries of posteriors of each species-level model
PS_NHM<- read_csv('../statsresults/NHM_Posterior_Summaries_M1.csv')
NHM_ForFitting <- read_csv(  '../data/NHM_for_models_monthly.csv')
```

```{r}
# Specialism 
specialism <- read_csv( '../data/specialism_with_nhm.csv')%>%
  mutate(Label = case_match(Specialism, 
                            'Habitat and foodplant generalist' ~ 'Habitat generalist\n&\nfoodplant generalist',
                            'Habitat and foodplant specialist'~ 'Habitat specialist\n&\nfoodplant specialist',
                            'Habitat generalist and foodplant specialist'~ 'Habitat generalist\n&\nfoodplant specialist',
                            'Habitat specialist and foodplant generalist'~  'Habitat specialist \n&\nfoodplant generalist'))

read_csv('../data/brood_table.csv') %>%
  filter(Include == 'TRUE' )%>%
  select(Sp = `Taxon name` ,Family )-> SpFamily

## Butterfly Red List https://resjournals.onlinelibrary.wiley.com/doi/10.1111/icad.12582
UKRedList <- read_csv('../data/ButterflyRedlistUK.csv')

```

# Prepping data
```{r}
PS_NHM %>%
  left_join(specialism, by =c( 'Sp'='Taxon name')) %>%
  left_join(SpFamily) %>%
  distinct(Specialism, Sp, Family ) %>%
  arrange(Specialism, Sp) -> OrderTable

ORDER_f2 <-pluck(OrderTable,'Sp')

OrderTable$Family_Cols <- c( 'darkgreen',"blue",  'orange',"gold", 'darkgrey', '#800020')[factor(pluck(OrderTable,'Family'))]
```

NB Glanville fritillary would otherwise overwhelm so truncating uncertainty. 

```{r}
PS_NHM %>%
  mutate(Sp  = factor(Sp, levels = ORDER_f2)) %>% 
  mutate( q5 = if_else(variable== 'b_Latitude' & Sp =='Melitaea cinxia',
                       -Inf, q5)) %>% 
  mutate( q16.7 = if_else(variable== 'b_Latitude' & Sp =='Melitaea cinxia',
                          -Inf, q16.7)) %>%
  left_join(specialism, by =c( 'Sp'='Taxon name')) %>%
  left_join(SpFamily) %>%
  left_join(UKRedList, by =c( 'Sp'='Species') ) %>%
  filter( variable %in% c( 'b_Temp',
                           'b_YearRescale',
                           'b_Sexmale',
                           'b_Latitude') )%>%
  mutate(Response = case_match(variable, 
                               'b_Temp'~ 'b. Temperature',
                               'b_YearRescale'~'c. Year',
                               'b_Sexmale'~'d. Male Offset',
                               'b_Latitude'~'a. Latitude') ) -> DataForMainNHMPlot
```

```{r}
NHM_for_fitting <- read_csv('../data/NHM_for_models_monthly.csv')
NHM_for_fitting %>%
  group_by(Sp)%>%
  summarise(MeanRightWing = signif(mean(Right_wing),4) ,
            SD_RightWing = signif(sd(Right_wing),4),
            CV_RightWing = signif(sd(Right_wing)/mean(Right_wing),4)) -> SpeciesSizeProps

write_csv(SpeciesSizeProps, '../data/SpeciesSizeProps.csv')### save average butterfly sizes to use for the Oxford data

PS_NHM %>%
  left_join(specialism, by =c( 'Sp'='Taxon name')) %>%
  left_join(UKRedList, by =c( 'Sp'='Species') ) %>%
  left_join(SpeciesSizeProps) %>%
  left_join(SpFamily) %>%
  mutate(RedListListed = ifelse(is.na( `GB Red List category`),
                                'Unlisted',
                                'Listed')) %>% 
  filter( variable %in% c( 'b_Temp',
                           'b_YearRescale') )%>%
  mutate(ConfidentTrend =  sign(q5)== sign(q95),
         TrendSign = ifelse(ConfidentTrend, sign(mean), 0)) %>%
  mutate( Generalist = Specialism == 'Habitat and foodplant generalist') %>%
  select(variable,Sp, Specialism , Family, RedListListed , TrendSign, Generalist,
         mean, sd, MeanRightWing,SD_RightWing ,CV_RightWing) -> Trends

```

# Species-level Results (Main Text Figure)
```{r}
DataForMainNHMPlot%>%
  mutate(Redlist = ifelse( is.na(`GB Red List category`),
                           'Unlisted', 'Listed')) %>%
  ggplot( aes( y =  fct_rev(Sp),
               x = mean))+
  geom_errorbarh(aes( xmin = q5, xmax = q95), linewidth = 1, height = 0, col = 'grey')+
  geom_errorbarh(aes(xmin = q16.7, xmax =  q83.3), linewidth = 2, height = 0, col = 'grey')+
  geom_point(shape = 4)+
  geom_vline(xintercept = 0)+
  facet_grid(Family ~Response, scales = 'free', space = "free_y")+
  ggtitle('')+
  theme_bw()+
  ylab('')+
  xlab('Fitted Coefficient')+
  theme(strip.text.y.right = element_text(angle = 0),
        axis.text.y = element_text(face =  "italic"),
        strip.background = element_rect(fill = 'grey80', colour = NA))

ggsave('../figs/NHM_Monthly_MainSpResults_byFamily.png', width = 10, height = 7, bg = 'white')
ggsave('../figs/NHM_Monthly_MainSpResults_byFamily.pdf', width = 10, height = 7, bg = 'white')
```

# Sample Size vs confidence (SI Figure)

```{r}

PS_NHM %>%
  filter( variable %in% c('b_YearRescale' , 'b_Temp'   , 'b_Latitude')) %>%
  left_join(count(NHM_ForFitting, Sp)) %>%
  mutate(ConfidentTrend =  sign(q5)== sign(q95)) %>%
  ggplot(aes( x = n, y = sd))+
  geom_point(aes(col = ConfidentTrend))+
  scale_colour_manual( values = c( 'brown', 'skyblue'),
                       name = 'Confident Trend?')+
  scale_x_sqrt()+
  facet_wrap(~variable, scales = 'free')+
  ylab('SD of posterior of fitted coefficients')+
  xlab('Sample size (NB Square-root scale)')+
  theme_bw()

ggsave('../figs/Corr_sample_size_trends_NHM.png', width = 9, height = 3)

```

# Predictors of Year Effect

## Size

### Model Fitting
```{r eval = FALSE}
PS_NHM %>%
  filter( variable == 'b_YearRescale' ) %>%
  brm( mean|mi(sd)  ~  1 ,
       data = .) -> bYear_model_NHM_Average



PS_NHM %>%
  filter( variable == 'b_YearRescale' ) %>%
  left_join(SpeciesSizeProps) %>%
  brm( mean|mi(sd)  ~  MeanRightWing ,
       data = .) -> bYear_model_NHM_Size

### Testing if effect can be explained as well just by family
PS_NHM %>%
  filter( variable == 'b_YearRescale' ) %>%
  left_join(SpeciesSizeProps) %>%
  left_join(SpFamily) %>%
  brm( mean|mi(sd)  ~  Family ,
       data = .) ->  bYear_model_NHM_Family

MS <- add_criterion(bYear_model_NHM_Size, criterion = 'loo')
MF <- add_criterion(bYear_model_NHM_Family, criterion = 'loo')


save(bYear_model_NHM_Average,file= '../TopLevelModelFits/bYear_model_NHM_Average')
save(MS, file='../TopLevelModelFits/bYear_model_NHM_Size')
save(MF, file='../TopLevelModelFits/bYear_model_NHM_Family')
```

```{r}
load('../TopLevelModelFits/bYear_model_NHM_Average')
load('../TopLevelModelFits/bYear_model_NHM_Size')
load('../TopLevelModelFits/bYear_model_NHM_Family')
```

###  What is average effect of 'Year_rescale'

```{r}
bYear_model_NHM_Average %>% posterior_summary()
```

### How does Size compare as a predictor to family?

```{r}
loo_compare(MS, MF)  # Can't differentiate 
```

### Plot For Figure R2a

```{r}
MS %>% posterior_summary() %>% as.data.frame()-> SizeEffectSummary
SizeEffectSummary

mcmc_hist(MS,
          pars = 'b_MeanRightWing')+
  xlab('Slope of Average Size vs bYear Coefficient,\naccounting for uncertainty')+
  theme_bw()


Trends %>%
  filter( variable == 'b_YearRescale' ) %>%
  ggplot(aes( x = MeanRightWing, y= mean))+
  geom_abline(intercept = SizeEffectSummary$Estimate[1],
              slope = SizeEffectSummary$Estimate[2])+
  geom_point(aes(col = Family))+
  theme_bw()+
  scale_color_manual(values =  c( 'darkgreen',"blue",  'orange',
                                  "gold", 'darkgrey', '#800020'))+
  theme(legend.position = 'bottom')+
  xlab('Butterfly Average Size,\n(Mean Right Wing)')+
  ylab('"Year" Coefficient') ->YearEffect_Size_Plot_nolabels

YearEffect_Size_Plot_nolabels
```

## Other non-significant predictors (Conservation status + specialism)

```{r eval = FALSE}
Trends %>%
  filter( variable == 'b_YearRescale' ) %>%
  brm( mean|mi(sd)  ~   Generalist     ,
       data = .) -> bYear_model_NHM_Specialism

Trends %>%
  filter( variable == 'b_YearRescale' ) %>%
  brm( mean|mi(sd)  ~   RedListListed      ,
       data = .) -> bYear_model_NHM_RedList

save(bYear_model_NHM_Specialism, file = '../TopLevelModelFits/bYear_model_NHM_Specialism')
save(bYear_model_NHM_RedList, file = '../TopLevelModelFits/bYear_model_NHM_RedList')
```

```{r}
load('../TopLevelModelFits/bYear_model_NHM_Specialism')
load('../TopLevelModelFits/bYear_model_NHM_RedList')

bYear_model_NHM_Specialism %>% posterior_summary()
bYear_model_NHM_RedList    %>% posterior_summary()

```

# Predictors of Effect of Late-Larval Temperature:

## Figure R2b

```{r}

Trends %>%
  filter( variable == 'b_Temp' ) %>%
  ggplot(aes( x = RedListListed, y= mean))+
  geom_boxplot(colour = 'grey80', fill = 'grey90', linewidth = 2)+
  geom_point(aes(shape = factor(TrendSign), col = Family))+
  scale_color_manual(values =  c( 'darkgreen',"blue",  'orange',
                                  "gold", 'darkgrey', '#800020'))+
  scale_shape_manual(values  = c(6,1,2))+
  theme_bw()+
  theme(legend.position = 'bottom')+
  xlab('UK Red List\nStatus')+
  ylab('"Temperature" Coefficient')  -> TempEffect_RedList_Plot_nolabels

TempEffect_RedList_Plot_nolabels
```

## Models for Redlist size (/family)  + specialism

```{R eval = FALSE}
PS_NHM %>%
  filter( variable == 'b_Temp' ) %>%
  left_join(UKRedList, by =c( 'Sp'='Species') ) %>%
  mutate(RedListListed = ifelse(is.na( `GB Red List category`),
                                'Unlisted', 'Listed')) %>%
  brm( mean|mi(sd)  ~  RedListListed ,
       data = .) -> bTemp_model_NHM_RedList

Trends %>%
  filter( variable == 'b_Temp' ) %>%
  brm( mean|mi(sd)  ~   Generalist     ,
       data = .) -> bTemp_model_NHM_Specialism

Trends %>%
  filter( variable == 'b_Temp' ) %>%
  brm( mean|mi(sd)  ~   MeanRightWing      ,
       data = .) -> bTemp_model_NHM_Size


save( bTemp_model_NHM_RedList, file = '../TopLevelModelFits/bTemp_model_NHM_RedList')
save(bTemp_model_NHM_Specialism, file = '../TopLevelModelFits/bTemp_model_NHM_Specialism')
save(bTemp_model_NHM_Size, file = '../TopLevelModelFits/bTemp_model_NHM_Size')
```

```{r}
load('../TopLevelModelFits/bTemp_model_NHM_RedList')
load('../TopLevelModelFits/bTemp_model_NHM_Specialism')
load('../TopLevelModelFits/bTemp_model_NHM_Size')

bTemp_model_NHM_RedList %>% posterior_summary()
bTemp_model_NHM_Specialism %>% posterior_summary()
bTemp_model_NHM_Size %>% posterior_summary()

```

# Repeating Tests with a Chi-Squared (largely excluded from paper for simplicilty)

```{r}
Trends %>%
  ggplot(aes( x = RedListListed, y= mean))+
  geom_boxplot()+
  geom_point(aes(col = factor(TrendSign)))+
  facet_wrap(~variable, scales = 'free_y')+
  geom_text(aes(label = Sp), size = 2 ,hjust=-0.15 )+
  theme_bw()

Trends %>%
  filter( variable == 'b_Temp' ) %>%
  ggplot(aes( x = RedListListed, y= mean))+
  geom_boxplot()+
  geom_point(aes(col = factor(TrendSign)))+
  geom_text(aes(label = Sp), size = 2 ,hjust=-0.15 )+
  theme_bw()+
  ylab('Temperature Coefficent')

Trends %>% 
  group_by(variable, RedListListed)%>%
  count( TrendSign) %>%
  pivot_wider(names_from = RedListListed,
              id_cols =c(variable,TrendSign),
              values_from = n ) %>%
  t %>%
  knitr::kable()

chisq.test(matrix(c(10,5,
                    4,12),2,2, byrow = TRUE)) 

chisq.test(matrix(c(10,5,
                    12,9,
                    4,12),3,2, byrow = TRUE))
```

N.B. TrendSign = just taking the three-way split of coefficients - positive, indeterminate, negative. 

### Generalism

```{r}
Trends %>%
  ggplot(aes( x = Generalist, y= mean))+
  geom_boxplot()+
  geom_point(aes(col = factor(TrendSign)))+
  facet_wrap(~variable, scales = 'free_y')+
  geom_text(aes(label = Sp), size = 2 ,hjust=-0.15 )

Trends %>%
  group_by(variable, Generalist)%>%
  count( TrendSign) %>%
  pivot_wider(names_from = Generalist,
              id_cols =c(variable,TrendSign),
              values_from = n ,
              values_fill = 0) %>%
  t %>%
  knitr::kable()

## Temperature pattern not significant however 0s are treated:
chisq.test(matrix(c(7,8,
                    13,3),2,2, byrow = TRUE))

chisq.test(matrix(c(7,8,
                    14,7,
                    13,3),3,2, byrow = TRUE))

## Year Pattern
chisq.test(matrix(c(5,0,16,11),2,2, byrow = TRUE))

chisq.test(matrix(c(5,0,
                    13,7,
                    16,11),3,2, byrow = TRUE))
```

### Family

Excluding families with only one member

```{r}
Trends %>%
  #filter( !Sp %in%  c('Papilio machaon', 'Hamearis lucina' )) %>%
  group_by(variable, Family)%>%
  count( TrendSign) %>%
  pivot_wider(names_from = Family,
              id_cols =c(variable,TrendSign),
              values_from = n ,
              values_fill = 0) ->FamilyDataForChiSq

FamilyDataForChiSq%>%
  t %>%
  knitr::kable()

Trends %>%
  ggplot(aes( x = Family, y = mean))+
  geom_boxplot()+
  geom_point()+
  facet_wrap(~variable, scales = 'free_y')


FamilyDataForChiSq %>%
  filter( variable == 'b_Temp' ) %>%
  ungroup()%>%
  select(Hesperiidae,Lycaenidae,Nymphalidae,Pieridae ) %>%
  as.matrix() %>%
  chisq.test()

```

# Generating Combined Figure for paper + names for SI

```{r}
Trends %>%
  filter( variable == 'b_YearRescale' ) %>%
  ggplot(aes( x = MeanRightWing, y= mean))+
  geom_abline(intercept = SizeEffectSummary$Estimate[1],
              slope = SizeEffectSummary$Estimate[2])+
  geom_point(aes(col = Family))+
  geom_text_repel(aes(label = Sp), size = 2 ,hjust=-0.15, direction = 'both' )+
  theme_bw()+
  scale_color_manual(values =  c( 'darkgreen',"blue",  'orange',
                                  "gold", 'darkgrey', '#800020'))+
  theme(legend.position = 'bottom')+
  xlab('Butterfly Average Size,\n(Mean Right Wing)')+
  ylab('Response to Year Coefficient') ->YearEffect_Size_Plot

Trends %>%
  filter( variable == 'b_Temp' ) %>%
  ggplot(aes( x = RedListListed, y= mean))+
  geom_boxplot(colour = 'grey80', fill = 'grey90', linewidth = 2)+
  geom_text_repel(aes(label = Sp), size = 2 ,hjust=-0.15, direction = 'y' )+
  geom_point(aes(shape = factor(TrendSign), col = Family))+
  scale_color_manual(values =  c( 'darkgreen',"blue",  'orange',
                                  "gold", 'darkgrey', '#800020'))+
  scale_shape_manual(values  = c(6,1,2))+
  theme_bw()+
  theme(legend.position = 'bottom')+
  xlab('UK Red List\nStatus')+
  ylab('Response to Temperature Coefficient')  -> TempEffect_RedList_Plot

plot_grid(plot_grid( YearEffect_Size_Plot +
                       guides( col = 'none'),
                     TempEffect_RedList_Plot+
                       guides( col = 'none', shape = 'none') ),
          get_legend(YearEffect_Size_Plot ),
          ncol=1 , rel_heights = c(5,1))

ggsave('../figs/PredictorsFigure_Both_withlabels.png',
       width = 10, height = 6, dpi = 300, bg = 'white')

#####
# Without text labels
#####

plot_grid(plot_grid( YearEffect_Size_Plot_nolabels +
                       guides( col = 'none'),
                     TempEffect_RedList_Plot_nolabels+
                       guides( col = 'none', shape = 'none') ),
          get_legend(YearEffect_Size_Plot_nolabels ),
          ncol=1 , rel_heights = c(5,1))

ggsave('../figs/PredictorsFigure_Both_nolabels.png',
       width = 7, height = 4, dpi = 300, bg = 'white')

```


# Session Info

```{r}
sessionInfo()
```